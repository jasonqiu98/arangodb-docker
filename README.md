# arangodb-docker

An environment to build a simple ArangoDB cluster with one agency node, two coordinator nodes and three DBServer nodes. Borrowed and adapted based on <https://github.com/Korov/Docker/blob/master/arangodb/cluster/docker-compose.yaml>.

## Access the default database through a coordinator in an ArangoDB Cluster

1. Make sure the Docker daemon is running on your machine.
2. If `logs` and `nodes` folders already exist and you don't need them anymore, remember to remove them by `sudo rm -rf nodes logs`; if you need them, back them up somewhere else before removing them.
3. Up the docker compose `docker compose up` (or in the backend: `docker compose up -d`), until you see some messages like the following. If you find the coordinators keep reconnecting with certain heartbeats, retry step 2.

```
arango-coordinator1  | 1664615273.522205 [1] INFO [99d80] {general} Waiting for initial replication of system collections...
arango-coordinator1  | 1664615273.525363 [1] INFO [99d80] {general} bootstrapped coordinator CRDN-cb5a2f36-e6c6-4740-b594-aaf743050f09
arango-coordinator1  | 1664615273.767095 [1] INFO [cf3f4] {general} ArangoDB (version 3.9.2 [linux]) is ready for business. Have fun!
arango-coordinator2  | 1664615274.306926 [1] INFO [99d80] {general} bootstrapped coordinator CRDN-1ac0a833-eebd-47c2-8354-f83a2331d5fc
arango-coordinator2  | 1664615274.538391 [1] INFO [cf3f4] {general} ArangoDB (version 3.9.2 [linux]) is ready for business. Have fun!
```

4. Open a new terminal and enter the `test` container by `docker exec -it arango-test sh`.
5. Connect to the default database `_system` via a coordinator, say `coordinator1` by
   - `arangosh --server.endpoint tcp://coordinator1:8529 --server.username root --server.password ""`

## [Optional] Import an extract of LDBC and then access the database

1. Make sure the Docker daemon is running on your machine.
2. If `logs` and `nodes` folders already exist and you don't need them anymore, remember to remove them by `sudo rm -rf nodes logs`; if you need them, back them up somewhere else before removing them.
3. Up the docker compose `docker compose up` (or in the backend: `docker compose up -d`), until you see some messages like the following. If you find the coordinators keep reconnecting with certain heartbeats, retry step 2.

```
arango-coordinator1  | 1664615273.522205 [1] INFO [99d80] {general} Waiting for initial replication of system collections...
arango-coordinator1  | 1664615273.525363 [1] INFO [99d80] {general} bootstrapped coordinator CRDN-cb5a2f36-e6c6-4740-b594-aaf743050f09
arango-coordinator1  | 1664615273.767095 [1] INFO [cf3f4] {general} ArangoDB (version 3.9.2 [linux]) is ready for business. Have fun!
arango-coordinator2  | 1664615274.306926 [1] INFO [99d80] {general} bootstrapped coordinator CRDN-1ac0a833-eebd-47c2-8354-f83a2331d5fc
arango-coordinator2  | 1664615274.538391 [1] INFO [cf3f4] {general} ArangoDB (version 3.9.2 [linux]) is ready for business. Have fun!
```

4. Open a new terminal and enter the `test` container by `docker exec -it arango-test sh`
5. Run the script `sh /resources/ldbc_extract/arangoimport.sh` to import an extract of LDBC
6. Connect to another database, say LDBC database `ldbc_snb_sf0001` via a coordinator, say `coordinator1` by
   - `arangosh --server.endpoint tcp://coordinator1:8529 --server.username root --server.password "" --server.database "ldbc_snb_sf0001"`

## Run a (sub-)project, e.g., "~/project/v6/quickstart-tutorial"

The path `/project` has been linked to the path `~/project` (i.e., `/root/project`) in the Docker container `arango-test`. Java 17 and Maven have been pre-installed within the Docker container.

```shell
cd ~/project/v6/quickstart-tutorial
mvn clean compile
mvn exec:java -Dexec.mainClass="com.jasonqiu.demo.Main"
```

## Stop and remove the cluster

- Stop
  - `docker compose stop` to stop all the services
- Remove
  - `docker compose down -v` or `docker compose down --volumes` to remove all the containers, networks and volumes generated by the `docker-compose.yml` file
  - Run `sudo rm -rf nodes logs` to delete relevant records/logs (if you don't need them for analysis any more)

## Misc.

1. Run `sudo chmod 777 logs/*/*.log` before accessing the log files on your local machine
2. Some example queries

```sql
db.Person.removeByKeys(["30786325580104"])
db._query('FOR p IN Person FILTER p.birthday_day > 18 RETURN p._key')
```

3. In `queries.log` files, code `[11160]` means the start of a query and code `[f5cee]` means the end.

4. JSON to Jackson

```java
ObjectMapper om = new ObjectMapper();
// https://stackoverflow.com/questions/39391095/how-to-convert-hashmap-to-jsonnode-with-jackson
JsonNode jsonNode = om.valueToTree(json);
System.out.println(jsonNode);
```

5. Rename a key of a HashMap `map`

```java
map.put("_key", map.remove("id"))
```

6. Use collections streams to generate ArangoDocument instances

```java
List<BaseDocument> personDocs = persons.stream().map(node -> {
    BaseDocument doc = new BaseDocument(node.get("id"));
    node.remove("id");
    doc.setProperties(new HashMap<>(node));
    return doc;
}).collect(Collectors.toList());

List<BaseEdgeDocument> knowsPersonsDocs = knowsPersons.stream().map(edge -> {
    // BaseEdgeDocument edge = new BaseEdgeDocument("myVertexCollection/myFromKey",
    // "myVertexCollection/myToKey");
    BaseEdgeDocument edgeDoc = new BaseEdgeDocument(
            "person/" + edge.remove("src.id"),
            "person/" + edge.remove("dst.id"));
    edgeDoc.setProperties(new HashMap<>(edge));
    return edgeDoc;
}).collect(Collectors.toList());
```

7. Access `http://localhost:8000` (for `coordinator1`) and `http://localhost:8001` (for `coordinator2`) in the browser, if the Web UI is needed.
